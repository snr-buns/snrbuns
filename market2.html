<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snr. Buns - Market Run</title>

  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&display=swap" rel="stylesheet" />

  <script type="module" src="auth.js"></script>

  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #fff4d6;
      margin: 0;
      display: flex;
      min-height: 100vh;
      color: #333;
    }
    .sidebar {
      background-color: #c82333;
      width: 220px;
      color: white;
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar h2 {
  font-weight: 700;
  font-size: 1.8rem;
  margin-bottom: 2rem;
  user-select: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.4rem;
  white-space: nowrap;   /* ‚úÖ prevents wrapping */
}

    .sidebar a {
      color: white;
      text-decoration: none;
      font-weight: 600;
      padding: 0.75rem 0.5rem;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background-color 0.3s;
      user-select: none;
    }
    .sidebar a:hover,
    .sidebar a.active {
      background-color: #a71d2a;
      text-decoration: none;
    }
    main {
      flex-grow: 1;
      padding: 2rem 3rem;
      background-color: #fff4d6;
      overflow-y: auto;
    }
    h1 {
      color: #c82333;
      font-weight: 700;
      margin-bottom: 2rem;
      user-select: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
      text-align: left;
      font-weight: 600;
      user-select: none;
    }
    th {
      background: #ffc107;
      color: #000;
    }
    input[type=number] {
      width: 80px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-weight: 600;
    }
    input[type=number]:focus {
      outline: 2px solid #c82333;
    }
    .price-input {
      width: 100px;
    }
    #totalCost {
      font-weight: 700;
      font-size: 1.25rem;
      margin-top: 1rem;
      user-select: none;
    }
    button#confirmPurchase {
      margin-top: 1.5rem;
      background-color: #c82333;
      color: white;
      font-weight: 700;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
    }
    button#confirmPurchase:hover {
      background-color: #a71d2a;
    }
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #c82333;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 700;
      font-family: 'Montserrat', sans-serif;
      display: none;
      z-index: 1000;
      max-width: 90vw;
      text-align: center;
      user-select: none;
    }
    .divider-row td {
      font-weight: 700;
      background-color: #dfd5bb;
      text-align: left;
      padding: 4px 10px;
      line-height: 1.2;
      font-size: 0.9rem;
    }

    /* Hamburger button */
.hamburger {
  display: none;
  font-size: 2rem;
  background: #c82333;
  color: white;
  border: none;
  border-radius: 8px;     /* matches other buttons */
  padding: 6px 12px;
  cursor: pointer;
  position: fixed;
  top: 15px;
  left: 15px;
  z-index: 3000;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25); /* permanent shadow */
  transition: background 0.2s;
}
.hamburger:hover {
  background: #a71d2a;
}


/* Sidebar adjustments for mobile */
@media (max-width: 768px) {
  .hamburger {
    display: block; /* show hamburger on small screens */
  }

  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 220px;
    background-color: #c82333;
    transform: translateX(-100%); /* hidden */
    transition: transform 0.3s ease;
    z-index: 1500;
  }

  .sidebar.active {
    transform: translateX(0); /* slide in */
  }

  /* Make sure main content isn‚Äôt squeezed */
  .main-container {
    flex-direction: column;
  }
  main {
    padding: 100px 1rem 1rem; /* top 60px so content sits below hamburger */
    margin-left: 0;
  }
}
  </style>
</head>
<body>
  <button id="menuToggle" class="hamburger">‚ò∞</button>
  <div class="main-container" style="display:flex; width:100%; min-height:100vh;">
  <aside class="sidebar">
    <h2>üçî Snr. Buns</h2>
    <nav>
      <ul class="list-unstyled">
        <li><a href="home.html">üè† Home</a></li>
        <li><a href="register.html">üñãÔ∏è Register</a></li>
        <li><a href="orders.html">üìã Orders</a></li>
        <li><a href="inventory.html">üì¶ Inventory</a></li>
        <li><a href="market.html" class="active">üè™ Market Run</a></li>
        <li><a href="staffmeals.html">üçΩÔ∏è Staff Meals</a></li>
        <li><a href="loyalty.html">üéÅ Customers</a></li>
      </ul>
    </nav>
  </aside>

  <main>
    <h1>üè™ Market Run</h1>

 <p style="font-weight:600; color:#c82333; margin-top:-1rem; margin-bottom:1.5rem;">
  As of right now, only those with permission from a manager are able to carry out market runs. <br><br>
  The suggested packs will give you enough ingredients to make 20 Heart Stopper Meals, 15 Bleeder Boxes and 10 Patty Pounder Combos.
</p>

<div class="mb-3">
  <label for="runnerName" class="form-label" style="font-weight:600; color:#c82333;">
    Staff Member Name:
  </label>
  <input type="text" id="runnerName" class="form-control" placeholder="Enter your name" />
</div>

    <table>
      <thead>
  <tr>
    <th>Ingredient</th>
    <th>Pack Quantity</th>
    <th>Price Per Pack ($)</th>
    <th>Subtotal ($)</th>
    <th>Suggested Packs</th>
  </tr>
</thead>
      <tbody>
        <tr class="divider-row">
          <td colspan="6">Food Stand</td>
        </tr>
         <tr>
          <td>Bottled Corn Syrup</td>
          <td><input type="number" min="0" value="0" data-ingredient="corn_syrup" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr>
        <tr>
          <td>Flour Sack</td>
          <td><input type="number" min="0" value="0" data-ingredient="flour" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr>
        <tr>
          <td>Package of Buns</td>
          <td><input type="number" min="0" value="0" data-ingredient="burger_buns" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr>
         <tr>
          <td>Sugar Sack</td>
          <td><input type="number" min="0" value="0" data-ingredient="sugar" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr>
        <tr class="divider-row">
          <td colspan="6">Fruit Stand</td>
        </tr>
        <tr>
          <td>Bag of Coffee</td>
          <td><input type="number" min="0" value="0" data-ingredient="coffee" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr>
        <tr>
          <td>Lettuce Head</td>
          <td><input type="number" min="0" value="0" data-ingredient="lettuce" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr>
        <tr>
          <td>Potato Sack</td>
          <td><input type="number" min="0" value="0" data-ingredient="potato" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr>
        <tr class="divider-row">
          <td colspan="6">Dairy Stand</td>
        </tr>
        <tr>
          <td>Packaged Cheese</td>
          <td><input type="number" min="0" value="0" data-ingredient="cheese_slices" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr>
         <tr class="divider-row">
          <td colspan="6">Meat Stand</td>
        </tr>
        <tr>
        <tr>
          <td>Bacon Package</td>
          <td><input type="number" min="0" value="0" data-ingredient="bacon" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr> 
        <tr>
          <td>Chicken Package</td>
          <td><input type="number" min="0" value="0" data-ingredient="chicken" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr>   
        <tr>    
          <td>Packaged Ground Beef</td>
          <td><input type="number" min="0" value="0" data-ingredient="ground_beef" class="pack-qty" /></td>
          <td><input type="number" min="0" step="0.01" value="0" class="price-per-pack" /></td>
          <td class="subtotal">$0.00</td>
          <td class="suggested"></td>
        </tr>      
        
      </tbody>
    </table>

    <div id="totalCost">Total Cost: $0.00</div>
    <div id="totalWeight">Total Weight: 0.0</div>

    <button id="confirmPurchase">Confirm Purchase</button>

    <div class="notification" id="notification"></div>
  </main>

<script type="module">
import {
  getFirestore, collection, query, where, orderBy, updateDoc, doc, onSnapshot, getDoc, addDoc, setDoc
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

import { app } from "./auth.js"; // reuses the initialized app
const db = getFirestore(app);

const inventoryDocRef = doc(db, "inventory", "current");
const UNIT_PER_PACK = 5;
const notification = document.getElementById('notification');

const ingredientNames = {
  corn_syrup: "Bottled Corn Syrup",
  flour: "Flour Sack",
  burger_buns: "Package of Buns",
  sugar: "Sugar Sack",
  lettuce: "Lettuce Head",
  potato: "Potato Sack",
  cheese_slices: "Packaged Cheese",
  ground_beef: "Packaged Ground Beef",
  chicken: "chicken",
  bacon: "bacon",
  coffee_beans: "coffee",
};


/* ===== Notifications ===== */
function showNotification(message, duration=3000) {
  notification.textContent = message;
  notification.style.display = 'block';
  notification.style.opacity = '1';
  if (showNotification.timeoutId) clearTimeout(showNotification.timeoutId);
  showNotification.timeoutId = setTimeout(() => {
    notification.style.transition = 'opacity 0.5s ease';
    notification.style.opacity = '0';
    notification.addEventListener('transitionend', () => {
      notification.style.display = 'none';
      notification.style.transition = '';
    }, { once: true });
  }, duration);
}

/* ===== Firestore Inventory ===== */
async function getLiveInventory() {
  const docSnap = await getDoc(inventoryDocRef);
  return docSnap.exists() ? docSnap.data() : {};
}

async function updateInventoryInFirestore(inventory) {
  try {
    await setDoc(inventoryDocRef, inventory, { merge: true });
    showNotification("Inventory updated.");
  } catch (error) {
    console.error("Firestore update failed:", error);
    showNotification("Failed to update inventory.");
  }
}

/* ===== Market Costs + Weight ===== */
function updateCosts() {
  const rows = document.querySelectorAll('tbody tr');
  let total = 0;
  let weight = 0;

  rows.forEach(row => {
    if (row.classList.contains("divider-row")) return;

    const qtyInput = row.querySelector('.pack-qty');
    const priceInput = row.querySelector('.price-per-pack');
    const subtotalCell = row.querySelector('.subtotal');

    if (!qtyInput || !priceInput || !subtotalCell) return;

    const qty = parseInt(qtyInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const subtotal = qty * price;

    subtotalCell.textContent = `$${subtotal.toFixed(2)}`;
    total += subtotal;

    // ‚úÖ Weight: default 5 per pack, lettuce = 2.5
    const ingredient = qtyInput.getAttribute('data-ingredient');
    if (ingredient) {
      if (ingredient === "lettuce") {
        weight += qty * 2.5;
      } else {
        weight += qty * 5;
      }
    }
  });

  document.getElementById('totalCost').textContent = `Total Cost: $${total.toFixed(2)}`;
  document.getElementById('totalWeight').textContent = `Total Weight: ${weight.toFixed(1)}`;
}

document.getElementById('confirmPurchase').addEventListener('click', async () => {
  const runnerName = document.getElementById('runnerName').value.trim();
  if (!runnerName) {
    showNotification("Please enter your name before confirming.");
    return;
  }

  const rows = document.querySelectorAll('tbody tr');
  let inventory = await getLiveInventory();
  let anyPurchase = false;
  let purchasedItems = []; // ‚úÖ store all items in one array

  for (const row of rows) {
    if (row.classList.contains("divider-row")) continue;

    const qtyInput = row.querySelector('.pack-qty');
    const priceInput = row.querySelector('.price-per-pack');
    const subtotalCell = row.querySelector('.subtotal');
    if (!qtyInput) continue;

    const ingredient = qtyInput.getAttribute('data-ingredient');
    const qty = parseInt(qtyInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;

    if (qty > 0) {
      anyPurchase = true;

      // ‚úÖ update inventory
      inventory[ingredient] = (inventory[ingredient] || 0) + qty * UNIT_PER_PACK;

      // ‚úÖ add to items array
      purchasedItems.push({
        ingredient,
        packsBought: qty,
        pricePerPack: price,
        subtotal: qty * price
      });

      // reset UI row
      qtyInput.value = 0;
      priceInput.value = 0;
      subtotalCell.textContent = "$0.00";
    }
  }

  if (!anyPurchase) {
    showNotification("Please enter quantity for at least one ingredient.");
    return;
  }

  // ‚úÖ Save ONE doc with all items
  const marketRun = {
    timestamp: new Date().toISOString(),
    runner: runnerName,
    items: purchasedItems,    // all items in one array
    totalCost: purchasedItems.reduce((sum, i) => sum + i.subtotal, 0)
  };

  try {
    await addDoc(collection(db, "market_runs"), marketRun);
    await updateInventoryInFirestore(inventory);
    updateCosts();
    showNotification("Market run saved successfully!");
  } catch (error) {
    console.error("Error adding market run:", error);
    showNotification("Failed to save market run.");
  }
});



document.querySelectorAll('.pack-qty, .price-per-pack').forEach(input => {
  input.addEventListener('input', updateCosts);
});

updateCosts();

/* ===== Dynamic Suggested Packs based on Inventory ===== */
async function setSuggestedPacks() {
  // Packs required for 15 Bleeders + 10 Pounders
  const required = {
  burger_buns: 35,
  ground_beef: 15,
  cheese_slices: 40,
  lettuce: 10,
  corn_syrup: 0,
  potato: 20,
  sugar: 7,
  flour: 7,
  chicken: 40,
  bacon: 30,
  coffee_beans: 75,
};

  const inventory = await getLiveInventory();

  document.querySelectorAll('tbody tr').forEach(row => {
    const qtyInput = row.querySelector('.pack-qty');
    const suggestedCell = row.querySelector('.suggested');
    if (!qtyInput || !suggestedCell) return;

    const ingredient = qtyInput.getAttribute('data-ingredient');
    if (ingredient && required[ingredient] !== undefined) {
      const currentUnits = inventory[ingredient] || 0;
      const currentPacks = Math.floor(currentUnits / UNIT_PER_PACK);
      const needed = Math.max(required[ingredient] - currentPacks, 0);
      suggestedCell.textContent = needed;
    }
  });
}

updateCosts();
setSuggestedPacks();
</script>
<script>
  const menuBtn = document.getElementById("menuToggle");
  const sidebar = document.querySelector(".sidebar");

  menuBtn.addEventListener("click", () => {
    sidebar.classList.toggle("active");

    // Switch between ‚ò∞ and ‚úñ
    if (sidebar.classList.contains("active")) {
      menuBtn.textContent = "‚úñ";
    } else {
      menuBtn.textContent = "‚ò∞";
    }
  });
</script>

</body>
</html>
