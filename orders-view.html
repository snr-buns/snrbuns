<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snr. Buns - Orders View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #fff4d6;
      color: #333;
    }
    h1 {
      color: #c82333;
      text-align: center;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      max-width: 1200px;
      margin: 0 auto 20px auto;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px 8px;
      text-align: center;
      word-break: break-word;
      white-space: nowrap;
    }
    th {
      background-color: #ffc107;
      color: #333;
    }
    #downloadCSV {
      display: block;
      margin: 0 auto 15px auto;
      padding: 10px 20px;
      background: #c82333;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      max-width: 260px;
      text-align: center;
    }
    #downloadCSV:hover {
      background: #a71d2a;
    }
    @media (max-width: 900px) {
      table { font-size: 0.8rem; }
      th, td { padding: 8px 6px; }
    }
  </style>
</head>
<body>
  <h1>üçî Snr. Buns - All Orders</h1>

  <button id="downloadCSV">‚¨áÔ∏è Download Orders CSV</button>

  <table id="ordersTable" aria-label="All Orders">
    <thead>
      <tr>
        <th>Date</th>
        <th>Employee</th>
        <th>Customer</th>

        <!-- BURGERS -->
        <th>Heart Stopper</th>
        <th>Money Shot</th>
        <th>The Simply</th>
        <th>Double Shot</th>
        <th>The Bleeder</th>
        <th>The Prickley</th>

        <!-- WRAPS -->
        <th>Chicken Wrap</th>
        <th>Chicken Mexican</th>
        <th>Goat Wrap</th>

        <!-- SIDES -->
        <th>Fries</th>
        <th>Onion Rings</th>

        <!-- DRINKS -->
        <th>Soda</th>
        <th>Coffee</th>

        <!-- DESSERTS -->
        <th>Rim Job</th>
        <th>Cream Pie</th>
        <th>Ice Cream</th>

        <th>Total</th>
        <th>Free Dessert?</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { app } from "./auth.js";
    import {
      getFirestore,
      collection,
      onSnapshot,
      query,
      orderBy,
      where
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

    const db = getFirestore(app);

    // ‚úÖ Master product list/order (matches orders.html)
    const PRODUCTS = [
      // BURGERS
      "Heart Stopper",
      "Money Shot",
      "The Simply",
      "Double Shot",
      "The Bleeder",
      "The Prickley",
      // WRAPS
      "Chicken Wrap",
      "Chicken Mexican",
      "Goat Wrap",
      // SIDES
      "Fries",
      "Onion Rings",
      // DRINKS
      "Soda",
      "Coffee",
      // DESSERTS
      "Rim Job",
      "Cream Pie",
      "Ice Cream"
    ];

    // ‚úÖ Combo breakdowns (synced with orders.html)
    const comboDetails = {
      "Big Buns Deal": [
        { name: "The Simply", quantity: 10 },
        { name: "Fries", quantity: 5 },
        { name: "Coffee", quantity: 15 },
        { name: "Rim Job", quantity: 1 }
      ],
      "The Bleeder Box": [
        { name: "The Bleeder", quantity: 5 },
        { name: "Fries", quantity: 5 },
        { name: "Coffee", quantity: 10 },
        { name: "Rim Job", quantity: 1 }
      ]
    };

    function formatEST(ts) {
      if (!ts) return "";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString("en-US", {
        timeZone: "America/New_York",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      }).replace(",", "");
    }

    // Expand combos and total per-product counts
    function parseItems(items = []) {
      const counts = {};
      PRODUCTS.forEach(p => counts[p] = 0);

      items.forEach(item => {
        const qty = Number(item.quantity || 0);
        const name = item.name;
        if (!qty) return;

        if (comboDetails[name]) {
          comboDetails[name].forEach(comp => {
            if (counts[comp.name] !== undefined) {
              counts[comp.name] += qty * Number(comp.quantity || 0);
            }
          });
        } else if (counts[name] !== undefined) {
          counts[name] += qty;
        }
      });

      return counts;
    }

    const tbody = document.querySelector("#ordersTable tbody");
    let ordersData = [];

    function renderOrders(orders) {
      tbody.innerHTML = "";
      if (orders.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${3 + PRODUCTS.length + 2}">No orders found.</td></tr>`;
        return;
      }

      orders.forEach(order => {
        const counts = parseItems(order.items || []);
        const tr = document.createElement("tr");

        // Build cells
        const cells = [
          formatEST(order.timestamp),
          order.employee || "-",
          order.customer || "-",
          ...PRODUCTS.map(p => (Number(counts[p] || 0))),
          (typeof order.total === "number" ? `$${order.total.toFixed(2)}` : "$0.00"),
          (order.freeDessert ? "Yes üç∞" : "")
        ];

        tr.innerHTML = cells.map(v => `<td>${v}</td>`).join("");
        tbody.appendChild(tr);
      });
    }

    // üîé Show only non-deleted orders, newest first
    const qRef = query(
      collection(db, "orders"),
      where("deleted", "==", false),
      orderBy("timestamp", "desc")
    );

    onSnapshot(qRef, (snapshot) => {
      ordersData = snapshot.docs.map(d => d.data());
      renderOrders(ordersData);
    });

    // CSV download
    document.getElementById("downloadCSV").addEventListener("click", () => {
      if (ordersData.length === 0) {
        alert("No orders to export!");
        return;
      }
      const csv = convertOrdersToCSV(ordersData);
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `BurgerShot_Orders_${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    function convertOrdersToCSV(orders) {
      const header = ["Date", "Employee", "Customer", ...PRODUCTS, "Total", "Free Dessert?"];
      const rows = orders.map(order => {
        const counts = parseItems(order.items || []);
        return [
          formatEST(order.timestamp),
          order.employee || "",
          order.customer || "",
          ...PRODUCTS.map(p => Number(counts[p] || 0)),
          (typeof order.total === "number" ? order.total.toFixed(2) : "0.00"),
          order.freeDessert ? "Yes" : "No"
        ];
      });

      // Quote each field to be safe for commas
      return [
        header.join(","),
        ...rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(","))
      ].join("\n");
    }
  </script>
</body>
</html>
